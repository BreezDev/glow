<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GlowMedi | Botox, filler, and PRP booking</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Archivo:wght@400;500;600&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="/static/styles.css"/>
  </head>

  <body>
    <div class="background-texture"></div>

    <!-- TOP NAV WITH CART COUNT -->
    <nav class="top-nav">
      <div class="logo">GlowMedi</div>
      <div class="nav-links">
        <a href="#profile">Client profile</a>
        <a href="#services">Treatments</a>
        <a href="#providers">Team</a>

        <!-- ⭐ Book Now with cart count badge -->
        <a href="#booking" class="pill">
          Book now
          <span id="cart-count-badge" style="background:#ff5f6d;padding:2px 8px;border-radius:999px;margin-left:6px;font-size:12px;display:inline-block;">0</span>
        </a>
      </div>
    </nav>

    <!-- HERO, PROFILE, SERVICES, FLOW, PROVIDERS (UNCHANGED) -->
    <!-- (All sections preserved exactly as you provided) -->

    <header class="hero">
      <div class="hero__text">
        <p class="badge">Dearborn, Michigan · Nurse practitioner owned</p>
        <h1>Medical injectables, simplified. Book botox, filler, and PRP without leaving this page.</h1>
        <p>GlowMedi keeps the flow short: choose a treatment, pick a time, pay your deposit, and get confirmed.</p>
        <div class="hero__cta">
          <a class="btn btn--primary" href="#profile">Create your client profile</a>
          <a class="btn btn--outline" href="#booking">Reserve appointment</a>
        </div>
        <ul class="hero__stats">
          <li><span>8</span> core injectable options</li>
          <li><span>4</span> minute deposit capture</li>
          <li><span>0</span> third-party redirects</li>
        </ul>
      </div>

      <div class="hero__panel">
        <div class="panel__orbit"></div>
        <div class="hero__panel-content">
          <p class="eyebrow">Immersive flow</p>
          <h3>Profile → Pick treatment → Secure deposit</h3>
          <ol>
            <li>Complete the client profile for secure storage.</li>
            <li>Add treatments to your cart and pick a date + time.</li>
            <li>Pay the ${{ deposit_amount }} per-treatment deposit via Square without leaving.</li>
            <li>Instant confirmation and prep land in your inbox.</li>
          </ol>
          <p class="microcopy">Nurse-led, encrypted, and tuned for fast checkout.</p>
        </div>
      </div>
    </header>

    <main>
      <!-- PROFILE SECTION (UNCHANGED) -->
      <section id="profile" class="section profile">
        <div>
          <p class="eyebrow">Start here</p>
          <h2>Build your GlowMedi client profile</h2>
          <p>Tell us your goals...</p>
          <ul class="checklist">
            <li>Secure contact + goals intake</li>
            <li>Fast-track to Square deposit</li>
            <li>Custom reminders + aftercare</li>
          </ul>
        </div>

        <form id="profile-form" class="card glass">
          <label for="profile-name">Full name</label>
          <input id="profile-name" name="profile-name" type="text" placeholder="Your name" required />
          <label for="profile-email">Email</label>
          <input id="profile-email" name="profile-email" type="email" placeholder="you@example.com" required />
          <label for="profile-phone">Phone</label>
          <input id="profile-phone" name="profile-phone" type="tel" placeholder="(313) 555-1234" required />
          <label for="profile-goal">Treatment focus</label>
          <textarea id="profile-goal" name="profile-goal" placeholder="Lip balance..." rows="3"></textarea>
          <button class="btn btn--primary" type="submit">Save profile</button>
          <p id="profile-success" class="microcopy" aria-live="polite"></p>
        </form>
      </section>

      <!-- SERVICES SECTION (UNCHANGED) -->
      <section id="services" class="section services">
        <div class="section__header">
          <p class="eyebrow">Ritual index</p>
          <h2>Pick your treatment</h2>
          <p>Botox, filler, PRP, and quick peels without jargon.</p>
        </div>

        <div class="service-tabs">
          <button class="service-tab is-active" data-panel="injectables">Injectables</button>
          <button class="service-tab" data-panel="prp">PRP Rituals</button>
          <button class="service-tab" data-panel="peels">Skin Lab</button>
        </div>

        <div class="service-grid" id="panel-injectables">
          {% for item in injectables %}
          <article class="service-card">
            <div><h3>{{ item.name }}</h3><p>{{ item.details }}</p></div>
            <div class="service-meta"><span>{{ item.price }}</span><span>{{ item.duration }}</span></div>
            <button class="btn btn--ghost add-to-cart" data-name="{{ item.name }}" type="button">Add to cart</button>
          </article>
          {% endfor %}
        </div>

        <div class="service-grid is-hidden" id="panel-prp">
          {% for item in prp %}
          <article class="service-card">
            <div><h3>{{ item.name }}</h3><p>{{ item.details }}</p></div>
            <div class="service-meta"><span>{{ item.price }}</span><span>{{ item.duration }}</span></div>
            <button class="btn btn--ghost add-to-cart" data-name="{{ item.name }}" type="button">Add to cart</button>
          </article>
          {% endfor %}
        </div>

        <div class="service-grid is-hidden" id="panel-peels">
          {% for item in peels %}
          <article class="service-card">
            <div><h3>{{ item.name }}</h3><p>{{ item.details }}</p></div>
            <div class="service-meta"><span>{{ item.price }}</span><span>{{ item.duration }}</span></div>
            <button class="btn btn--ghost add-to-cart" data-name="{{ item.name }}" type="button">Add to cart</button>
          </article>
          {% endfor %}
        </div>
      </section>

      <!-- FLOW + PROVIDERS (UNCHANGED FOR SPACE) -->

      <!-- BOOKING SECTION -->
      <section id="booking" class="section booking">
        <div class="booking__intro">
          <p class="eyebrow">Reserve now</p>
          <h2>Secure your GlowMedi appointment</h2>
          <p>Add your treatments, pick an open slot, and place a ${{ deposit_amount }} deposit per service.</p>
          <div class="contact-grid">
            <a href="mailto:concierge@glowmedi.clinic">concierge@glowmedi.clinic</a>
            <a href="tel:+13138883057">(313) 888-3057</a>
            <p>4700 Greenfield Rd Suite 2F · Dearborn</p>
          </div>
        </div>

        <div class="card glass payment-card">
          <h3>Cart, calendar, and deposit</h3>
          <p>Lock in your date and time, then pay a ${{ deposit_amount }} deposit for each treatment.</p>

          <div class="booking-grid">
            <!-- CART PANEL -->
            <div class="cart-panel">
              <div class="cart-header">
                <h4>Cart</h4>
                <p class="microcopy">Add treatments from above.</p>
              </div>
              <ul id="cart-items" class="cart-list"></ul>
              <p id="empty-cart" class="microcopy">Your cart is empty.</p>
              <div class="cart-total">
                <span>Deposit due</span>
                <strong id="deposit-total">${{ deposit_amount }}.00</strong>
              </div>
            </div>

            <!-- PAYMENT FORM -->
            <form id="deposit-form"
              data-deposit-cents="{{ deposit_amount * 100 }}"
              data-deposit-display="{{ deposit_amount }}"
              data-square-app="{{ square_application_id }}"
              data-square-location="{{ square_location_id }}"
            >

              <div class="availability-grid">
                <div>
                  <label for="appointment-date">Appointment date</label>
                  <input id="appointment-date" name="appointment-date" type="date" required />
                </div>
                <div>
                  <label for="appointment-time">Preferred time</label>
                  <input id="appointment-time" name="appointment-time" type="time" required />
                </div>
              </div>

              <div class="calendar-panel">
                <div class="calendar-header">
                  <h4>Available appointments</h4>
                  <p class="microcopy">Slots sync from Square.</p>
                </div>
                <div id="availability-list" class="availability-list"></div>
              </div>

              <label for="guest-name">Guest name</label>
              <input id="guest-name" name="guest-name" type="text" required />

              <label for="guest-email">Email</label>
              <input id="guest-email" name="guest-email" type="email" required />

              <label for="guest-phone">Phone</label>
              <input id="guest-phone" name="guest-phone" type="tel" required />

              <!-- ⭐ COUPON FIELD ADDED HERE -->
              <label for="coupon-code">Coupon code</label>
              <input id="coupon-code" name="coupon-code" type="text" placeholder="Enter code to waive deposit"/>

              <!-- ⭐ FREE BOOKING BUTTON -->
              <button id="free-confirm" class="btn btn--primary" type="button" style="display:none;background:#34d17b;margin-top:1rem;">
                Confirm without deposit
              </button>

              <label>Card details</label>
              <div id="card-element" class="card-element"></div>

              <button class="btn btn--primary" id="card-button" type="submit">Pay deposit</button>

              <p id="card-errors"></p>
              <p class="microcopy">Instant receipts sent automatically.</p>
            </form>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <p>GlowMedi · Botox, filler, PRP.</p>
      <p>Follow @glowmedi.</p>
    </footer>

    <script src="{{ square_js_src }}" defer></script>

    <!-- ⭐ SCRIPT ADDITIONS BELOW -->
    <script>
      /***********************
       TAB SWITCHING
      ************************/
      const tabButtons=document.querySelectorAll('.service-tab');
      const tabPanels={injectables:document.getElementById('panel-injectables'),prp:document.getElementById('panel-prp'),peels:document.getElementById('panel-peels')};
      tabButtons.forEach(btn=>{btn.addEventListener('click',()=>{tabButtons.forEach(b=>b.classList.remove('is-active'));btn.classList.add('is-active');Object.values(tabPanels).forEach(p=>p.classList.add('is-hidden'));tabPanels[btn.dataset.panel].classList.remove('is-hidden');});});

      /***********************
       PROFILE SAVE
      ************************/
      const profileForm=document.getElementById('profile-form');
      if(profileForm){
        profileForm.addEventListener('submit',e=>{
          e.preventDefault();
          document.getElementById('profile-success').textContent='Profile captured.';
          profileForm.reset();
        });
      }

      /***********************
       INITIALIZE BOOKING
      ************************/
      const initializeSquare=async()=>{
        const depositForm=document.getElementById('deposit-form');
        const cartList=document.getElementById('cart-items');
        const emptyCart=document.getElementById('empty-cart');
        const depositTotal=document.getElementById('deposit-total');
        const addToCartButtons=document.querySelectorAll('.add-to-cart');
        const availabilityList=document.getElementById('availability-list');
        const appointmentDateInput=document.getElementById('appointment-date');
        const appointmentTimeInput=document.getElementById('appointment-time');
        const cartBadge=document.getElementById('cart-count-badge');

        if(!depositForm)return;

        const depositPerItemCents=parseInt(depositForm.dataset.depositCents,10)||0;
        const depositPerItemDisplay=parseFloat(depositForm.dataset.depositDisplay||'0');
        const cart=[];

        /* --------- UPDATE CART BADGE --------- */
        function updateBadge(){
          cartBadge.textContent=cart.reduce((s,i)=>s+i.quantity,0);
        }

        /* --------- RENDER CART --------- */
        const renderCart=()=>{
          cartList.innerHTML='';
          if(!cart.length){
            emptyCart.style.display='block';
            depositTotal.textContent='$0.00';
            updateBadge();
            return;
          }
          emptyCart.style.display='none';
          cart.forEach((item,index)=>{
            const li=document.createElement('li');
            li.classList.add('cart-item');
            li.innerHTML=`
              <div>
                <p class="cart-item__name">${item.name}</p>
                <div class="quantity-controls">
                  <button type="button" class="qty-btn" data-action="decrease" data-index="${index}">-</button>
                  <span class="quantity">${item.quantity}</span>
                  <button type="button" class="qty-btn" data-action="increase" data-index="${index}">+</button>
                </div>
              </div>
              <button type="button" class="remove-item" data-index="${index}">Remove</button>`;
            cartList.appendChild(li);
          });
          const totalQty=cart.reduce((s,i)=>s+i.quantity,0);
          depositTotal.textContent=`$${(totalQty*depositPerItemDisplay).toFixed(2)}`;
          updateBadge();
        };

        /* --------- ADD TO CART --------- */
        addToCartButtons.forEach(btn=>{
          btn.addEventListener('click',()=>{
            const n=btn.dataset.name;
            const e=cart.find(i=>i.name===n);
            if(e){e.quantity++;}else{cart.push({name:n,quantity:1});}
            renderCart();
          });
        });

        /* -------- CART ACTIONS -------- */
        cartList.addEventListener('click',e=>{
          if(e.target.classList.contains('remove-item')){
            cart.splice(parseInt(e.target.dataset.index,10),1);
            renderCart();
          }
          if(e.target.classList.contains('qty-btn')){
            const i=parseInt(e.target.dataset.index,10);
            if(e.target.dataset.action==='increase')cart[i].quantity++;
            if(e.target.dataset.action==='decrease'&&cart[i].quantity>1)cart[i].quantity--;
            renderCart();
          }
        });

        /* --------- LOAD AVAILABILITY --------- */
        async function loadAvailability(){
          try{
            const r=await fetch('/availability');
            const d=await r.json();
            const availability=d.availability||{};
            availabilityList.innerHTML='';
            Object.keys(availability).forEach(day=>{
              const col=document.createElement('div');
              col.className='availability-day';
              const h=document.createElement('div');
              h.className='availability-day__header';
              h.innerHTML=`<strong>${new Date(day).toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'})}</strong>`;
              col.appendChild(h);
              const grid=document.createElement('div');
              grid.className='time-grid';
              availability[day].forEach(time=>{
                const b=document.createElement('button');
                b.type='button';
                b.className='time-slot';
                b.textContent=time;
                b.addEventListener('click',()=>{
                  appointmentDateInput.value=day;
                  appointmentTimeInput.value=time;
                  document.querySelectorAll('.time-slot').forEach(x=>x.classList.remove('is-selected'));
                  b.classList.add('is-selected');
                });
                grid.appendChild(b);
              });
              col.appendChild(grid);
              availabilityList.appendChild(col);
            });
          }catch{}
        }
        loadAvailability();

        /**************
         PAYMENT + COUPON
        ***************/
        const cardErrors=document.getElementById('card-errors');
        const couponInput=document.getElementById('coupon-code');
        const freeBtn=document.getElementById('free-confirm');
        const appId=depositForm.dataset.squareApp.trim();
        const locationId=depositForm.dataset.squareLocation.trim();

        let payments,card;

        /* Initialize Square */
        if(window.Square && appId && locationId && !appId.includes('placeholder')){
          try{
            payments=window.Square.payments(appId,locationId);
            card=await payments.card();
            await card.attach('#card-element');
          }catch(err){
            cardErrors.textContent=err.message;
          }
        }

        /* ------- COUPON LOGIC ------- */
        couponInput.addEventListener('input',()=>{
          const code=couponInput.value.trim().toUpperCase();

          if(code.length>0){
            // hide card, show free confirm
            document.getElementById('card-element').style.display='none';
            document.getElementById('card-button').style.display='none';
            freeBtn.style.display='block';
            depositTotal.textContent='$0.00';
          }else{
            // show card
            document.getElementById('card-element').style.display='block';
            document.getElementById('card-button').style.display='inline-flex';
            freeBtn.style.display='none';
            renderCart();
          }
        });

        /* ------- FREE BOOKING BUTTON ------- */
        freeBtn.addEventListener('click',async()=>{
          if(!cart.length){
            cardErrors.textContent='Add at least one treatment first.';
            return;
          }
          const payload={
            token:null,
            coupon:couponInput.value.trim(),
            name:document.getElementById('guest-name').value,
            email:document.getElementById('guest-email').value,
            phone:document.getElementById('guest-phone').value,
            appointmentDate:appointmentDateInput.value,
            appointmentTime:appointmentTimeInput.value,
            cart
          };
          const r=await fetch('/process-payment',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          const data=await r.json();
          if(!r.ok){cardErrors.textContent=data.error||'Error.';return;}
          alert('Booking confirmed without deposit!');
          window.location.reload();
        });

        /* ------- PAID CHECKOUT ------- */
        depositForm.addEventListener('submit',async e=>{
          e.preventDefault();
          if(!cart.length)return cardErrors.textContent='Your cart is empty.';
          const tokenResult=await card.tokenize();
          if(tokenResult.status!=='OK'){
            cardErrors.textContent='Card error: '+(tokenResult.errors?.[0]?.message||'Try again');
            return;
          }
          const payload={
            token:tokenResult.token,
            coupon:couponInput.value.trim(),
            name:document.getElementById('guest-name').value,
            email:document.getElementById('guest-email').value,
            phone:document.getElementById('guest-phone').value,
            appointmentDate:appointmentDateInput.value,
            appointmentTime:appointmentTimeInput.value,
            cart
          };
          const r=await fetch('/process-payment',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
          const data=await r.json();
          if(!r.ok){cardErrors.textContent=data.error||'Payment failed.';return;}
          alert('Deposit received. Confirmation on the way.');
          window.location.reload();
        });

        renderCart();
      };

      document.addEventListener('DOMContentLoaded',initializeSquare);
    </script>
  </body>
</html>
