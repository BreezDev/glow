<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GlowMedi | Botox, filler, and PRP booking</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Archivo:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="background-texture"></div>
    <nav class="top-nav">
      <div class="logo">GlowMedi</div>
      <div class="nav-links">
        <a href="#profile">Client profile</a>
        <a href="#services">Treatments</a>
        <a href="#providers">Team</a>
        <a href="#booking" class="pill">Book now</a>
      </div>
    </nav>

    <header class="hero">
      <div class="hero__text">
        <p class="badge">Dearborn, Michigan · Nurse practitioner owned</p>
        <h1>
          Medical injectables, simplified. Book botox, filler, and PRP without leaving this page.
        </h1>
        <p>GlowMedi keeps the flow short: choose a treatment, pick a time, pay your deposit, and get confirmed.</p>
        <div class="hero__cta">
          <a class="btn btn--primary" href="#profile">Create your client profile</a>
          <a class="btn btn--outline" href="#booking">Reserve appointment</a>
        </div>
        <ul class="hero__stats">
          <li><span>8</span> core injectable options</li>
          <li><span>4</span> minute deposit capture</li>
          <li><span>0</span> third-party redirects</li>
        </ul>
      </div>
      <div class="hero__panel">
        <div class="panel__orbit"></div>
        <div class="hero__panel-content">
          <p class="eyebrow">Immersive flow</p>
          <h3>Profile → Pick treatment → Secure deposit</h3>
          <ol>
            <li>Complete the client profile for secure storage.</li>
            <li>Add treatments to your cart and pick a date + time.</li>
            <li>Pay the ${{ deposit_amount }} per-treatment deposit via Square without leaving.</li>
            <li>Instant confirmation and prep land in your inbox.</li>
          </ol>
          <p class="microcopy">Nurse-led, encrypted, and tuned for fast checkout.</p>
        </div>
      </div>
    </header>

    <main>
      <section id="profile" class="section profile">
        <div>
          <p class="eyebrow">Start here</p>
          <h2>Build your GlowMedi client profile</h2>
          <p>
            Tell us your goals, preferred communication channel, and the treatments you're eyeing. The profile locks in
            concierge messaging, intake paperwork, and same-page booking.
          </p>
          <ul class="checklist">
            <li>Secure contact + goals intake</li>
            <li>Fast-track to Square deposit</li>
            <li>Custom reminders + aftercare</li>
          </ul>
        </div>
        <form id="profile-form" class="card glass">
          <label for="profile-name">Full name</label>
          <input id="profile-name" name="profile-name" type="text" placeholder="Your name" required />
          <label for="profile-email">Email</label>
          <input id="profile-email" name="profile-email" type="email" placeholder="you@example.com" required />
          <label for="profile-phone">Phone</label>
          <input id="profile-phone" name="profile-phone" type="tel" placeholder="(313) 555-1234" required />
          <label for="profile-goal">Treatment focus</label>
          <textarea id="profile-goal" name="profile-goal" placeholder="Lip balance, tox refresh, PRP..." rows="3"></textarea>
          <button class="btn btn--primary" type="submit">Save profile</button>
          <p id="profile-success" class="microcopy" aria-live="polite"></p>
        </form>
      </section>

      <section id="services" class="section services">
        <div class="section__header">
          <p class="eyebrow">Ritual index</p>
          <h2>Pick your treatment</h2>
          <p>Botox, filler, PRP, and quick peels without jargon. Tap to add to your cart.</p>
        </div>
        <div class="service-tabs">
          <button class="service-tab is-active" data-panel="injectables">Injectables</button>
          <button class="service-tab" data-panel="prp">PRP Rituals</button>
          <button class="service-tab" data-panel="peels">Skin Lab</button>
        </div>
        <div class="service-grid" id="panel-injectables">
          {% for item in injectables %}
          <article class="service-card">
            <div>
              <h3>{{ item.name }}</h3>
              <p>{{ item.details }}</p>
            </div>
            <div class="service-meta">
              <span>{{ item.price }}</span>
              <span>{{ item.duration }}</span>
            </div>
            <button class="btn btn--ghost add-to-cart" data-name="{{ item.name }}" type="button">Add to cart</button>
          </article>
          {% endfor %}
        </div>
        <div class="service-grid is-hidden" id="panel-prp">
          {% for item in prp %}
          <article class="service-card">
            <div>
              <h3>{{ item.name }}</h3>
              <p>{{ item.details }}</p>
            </div>
            <div class="service-meta">
              <span>{{ item.price }}</span>
              <span>{{ item.duration }}</span>
            </div>
            <button class="btn btn--ghost add-to-cart" data-name="{{ item.name }}" type="button">Add to cart</button>
          </article>
          {% endfor %}
        </div>
        <div class="service-grid is-hidden" id="panel-peels">
          {% for item in peels %}
          <article class="service-card">
            <div>
              <h3>{{ item.name }}</h3>
              <p>{{ item.details }}</p>
            </div>
            <div class="service-meta">
              <span>{{ item.price }}</span>
              <span>{{ item.duration }}</span>
            </div>
            <button class="btn btn--ghost add-to-cart" data-name="{{ item.name }}" type="button">Add to cart</button>
          </article>
          {% endfor %}
        </div>
      </section>

      <section class="section flow">
        <div class="section__header">
          <p class="eyebrow">Always-on concierge</p>
          <h2>Everything lives on one screen</h2>
        </div>
        <div class="flow-grid">
          <article>
            <span>01</span>
            <h3>Profile</h3>
            <p>Drop your contact details and treatment goal.</p>
          </article>
          <article>
            <span>02</span>
            <h3>Select treatment</h3>
            <p>Add botox, filler, or PRP to your cart.</p>
          </article>
          <article>
            <span>03</span>
            <h3>Book + deposit</h3>
            <p>Choose an open time and pay the small deposit.</p>
          </article>
          <article>
            <span>04</span>
            <h3>Confirm</h3>
            <p>Get instant confirmation and simple aftercare.</p>
          </article>
        </div>
      </section>

      <section id="providers" class="section team">
        <article>
          <p class="eyebrow">Clinical Director</p>
          <h2>Farah Bazzi, NP</h2>
          <p>
            Fearless facial balancing, bio-stimulators, and sculpted contours executed with a modern point of view. Farah
            leads clinical decisions, intake review, and post-visit analysis.
          </p>
          <ul>
            <li>Advanced contouring + midface restoration</li>
            <li>Strategic neurotoxin mapping</li>
            <li>Layered skin quality protocols</li>
          </ul>
        </article>
        <article>
          <p class="eyebrow">Aesthetic Partner</p>
          <h2>Malak Sabbagh, NP</h2>
          <p>
            Velvet lip stories, PRP revivals, and discreet maintenance sessions anchored by calm bedside manner and
            concierge communication.
          </p>
          <ul>
            <li>Lip flips, filler, and touch-ups</li>
            <li>PRP hair + under-eye restoration</li>
            <li>Smooth, discreet maintenance visits</li>
          </ul>
        </article>
      </section>

      <section id="booking" class="section booking">
        <div class="booking__intro">
          <p class="eyebrow">Reserve now</p>
          <h2>Secure your GlowMedi appointment</h2>
          <p>Add your treatments, pick an open slot, and place a ${{ deposit_amount }} deposit per service.</p>
          <div class="contact-grid">
            <a href="mailto:concierge@glowmedi.clinic">concierge@glowmedi.clinic</a>
            <a href="tel:+13138883057">(313) 888-3057</a>
            <p>4700 Greenfield Rd Suite 2F · Dearborn</p>
          </div>
        </div>
        <div class="card glass payment-card">
          <h3>Cart, calendar, and deposit</h3>
          <p>Lock in your date and time, then pay a ${{ deposit_amount }} deposit for each treatment in your cart.</p>
          <div class="booking-grid">
            <div class="cart-panel">
              <div class="cart-header">
                <h4>Cart</h4>
                <p class="microcopy">Add treatments from the sections above.</p>
              </div>
              <ul id="cart-items" class="cart-list"></ul>
              <p id="empty-cart" class="microcopy">Your cart is empty. Add at least one treatment to continue.</p>
              <div class="cart-total">
                <span>Deposit due</span>
                <strong id="deposit-total">${{ deposit_amount }}.00</strong>
              </div>
            </div>
            <form
              id="deposit-form"
              data-deposit-cents="{{ deposit_amount * 100 }}"
              data-deposit-display="{{ deposit_amount }}"
              data-square-app="{{ square_application_id }}"
              data-square-location="{{ square_location_id }}"
            >
              <div class="availability-grid">
                <div>
                  <label for="appointment-date">Appointment date</label>
                  <input id="appointment-date" name="appointment-date" type="date" required />
                </div>
                <div>
                  <label for="appointment-time">Preferred time</label>
                  <input id="appointment-time" name="appointment-time" type="time" required />
                </div>
              </div>
              <div class="calendar-panel" aria-live="polite">
                <div class="calendar-header">
                  <h4>Available appointments</h4>
                  <p class="microcopy">Slots sync from Stripe availability.</p>
                </div>
                <div id="availability-list" class="availability-list"></div>
              </div>
              <label for="guest-name">Guest name</label>
              <input id="guest-name" name="guest-name" type="text" placeholder="Full name" required />
              <label for="guest-email">Email</label>
              <input id="guest-email" name="guest-email" type="email" placeholder="you@example.com" required />
              <label for="guest-phone">Phone</label>
              <input id="guest-phone" name="guest-phone" type="tel" placeholder="(313) 555-1234" required />
              <label>Card details</label>
              <div id="card-element" class="card-element"></div>
              <button class="btn btn--primary" id="card-button" type="submit">Pay deposit</button>
              <p id="card-errors" role="alert"></p>
              <p class="microcopy">Instant receipts + aftercare delivered automatically to you and the clinical team.</p>
            </form>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <p>GlowMedi · Botox, filler, PRP, and peels in Dearborn.</p>
      <p>Follow @glowmedi and reply to confirmation emails for concierge support.</p>
    </footer>

    <script src="{{ square_js_src }}" defer></script>
    <script>
      const tabButtons = document.querySelectorAll('.service-tab');
      const tabPanels = {
        injectables: document.getElementById('panel-injectables'),
        prp: document.getElementById('panel-prp'),
        peels: document.getElementById('panel-peels')
      };

      tabButtons.forEach((button) => {
        button.addEventListener('click', () => {
          tabButtons.forEach((btn) => btn.classList.remove('is-active'));
          button.classList.add('is-active');
          Object.values(tabPanels).forEach((panel) => panel.classList.add('is-hidden'));
          const panel = tabPanels[button.dataset.panel];
          if (panel) {
            panel.classList.remove('is-hidden');
          }
        });
      });

      const profileForm = document.getElementById('profile-form');
      const profileSuccess = document.getElementById('profile-success');
      if (profileForm) {
        profileForm.addEventListener('submit', (event) => {
          event.preventDefault();
          profileSuccess.textContent = 'Profile captured. Jump to the booking section to secure your visit.';
          profileForm.reset();
        });
      }

      const initializeSquare = async () => {
        const depositForm = document.getElementById('deposit-form');
        const cardErrors = document.getElementById('card-errors');
        const cartList = document.getElementById('cart-items');
        const emptyCart = document.getElementById('empty-cart');
        const depositTotal = document.getElementById('deposit-total');
        const addToCartButtons = document.querySelectorAll('.add-to-cart');
        const availabilityList = document.getElementById('availability-list');
        const appointmentDateInput = document.getElementById('appointment-date');
        const appointmentTimeInput = document.getElementById('appointment-time');

        if (!depositForm) return;

        const depositPerItemCents = parseInt(depositForm.dataset.depositCents, 10) || 0;
        const depositPerItemDisplay = parseFloat(depositForm.dataset.depositDisplay || '0');
        const cart = [];

        const renderCart = () => {
          cartList.innerHTML = '';
          if (!cart.length) {
            emptyCart.style.display = 'block';
            depositTotal.textContent = '$0.00';
            return;
          }

          emptyCart.style.display = 'none';

          cart.forEach((item, index) => {
            const li = document.createElement('li');
            li.classList.add('cart-item');
            li.innerHTML = `
              <div>
                <p class="cart-item__name">${item.name}</p>
                <div class="quantity-controls">
                  <button type="button" class="qty-btn" data-action="decrease" data-index="${index}" aria-label="Decrease quantity">-</button>
                  <span class="quantity">${item.quantity}</span>
                  <button type="button" class="qty-btn" data-action="increase" data-index="${index}" aria-label="Increase quantity">+</button>
                </div>
              </div>
              <button type="button" class="remove-item" data-index="${index}">Remove</button>
            `;
            cartList.appendChild(li);
          });

          const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
          const totalDeposit = depositPerItemDisplay * totalQuantity;
          depositTotal.textContent = `$${totalDeposit.toFixed(2)}`;
        };

        addToCartButtons.forEach((button) => {
          button.addEventListener('click', () => {
            const name = button.dataset.name;
            const existing = cart.find((item) => item.name === name);
            if (existing) {
              existing.quantity += 1;
            } else {
              cart.push({ name, quantity: 1 });
            }
            renderCart();
            cardErrors.textContent = '';
          });
        });

        cartList.addEventListener('click', (event) => {
          const target = event.target;
          if (target.classList.contains('remove-item')) {
            const index = parseInt(target.dataset.index, 10);
            cart.splice(index, 1);
            renderCart();
          }

          if (target.classList.contains('qty-btn')) {
            const index = parseInt(target.dataset.index, 10);
            const action = target.dataset.action;
            if (action === 'increase') {
              cart[index].quantity += 1;
            }
            if (action === 'decrease' && cart[index].quantity > 1) {
              cart[index].quantity -= 1;
            }
            renderCart();
          }
        });

        const renderAvailability = (availability) => {
          availabilityList.innerHTML = '';
          const dates = Object.keys(availability || {});

          if (!dates.length) {
            availabilityList.innerHTML = '<p class="microcopy">No Stripe availability found. Use the fields above to pick a time.</p>';
            return;
          }

          let firstAvailableSelected = false;

          dates.forEach((slotDate) => {
            const dayColumn = document.createElement('div');
            dayColumn.classList.add('availability-day');

            const dayHeader = document.createElement('div');
            dayHeader.classList.add('availability-day__header');
            const day = new Date(slotDate);
            dayHeader.innerHTML = `<strong>${day.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' })}</strong>`;
            dayColumn.appendChild(dayHeader);

            const times = availability[slotDate] || [];
            const buttonsWrap = document.createElement('div');
            buttonsWrap.classList.add('time-grid');
            times.forEach((time) => {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.classList.add('time-slot');
              btn.textContent = time;
              btn.addEventListener('click', () => {
                appointmentDateInput.value = slotDate;
                appointmentTimeInput.value = time;
                Array.from(availabilityList.querySelectorAll('.time-slot')).forEach((b) => b.classList.remove('is-selected'));
                btn.classList.add('is-selected');
              });
              buttonsWrap.appendChild(btn);

              if (!firstAvailableSelected && (!appointmentDateInput.value || !appointmentTimeInput.value)) {
                appointmentDateInput.value = slotDate;
                appointmentTimeInput.value = time;
                btn.classList.add('is-selected');
                firstAvailableSelected = true;
              }
            });
            dayColumn.appendChild(buttonsWrap);
            availabilityList.appendChild(dayColumn);
          });
        };

        const loadAvailability = async () => {
          try {
            const response = await fetch('/availability');
            if (!response.ok) return;
            const data = await response.json();
            renderAvailability(data.availability);
          } catch (error) {
            // leave form usable without availability
          }
        };

        loadAvailability();

        if (!window.Square) {
          return;
        }

        const appId = (depositForm.dataset.squareApp || '').trim();
        const locationId = (depositForm.dataset.squareLocation || '').trim();

        if (!appId || !locationId || appId.includes('placeholder')) {
          cardErrors.textContent = 'Payment configuration is missing or misformatted. Please confirm the Square application ID and location ID.';
          return;
        }

        let payments;
        try {
          payments = window.Square.payments(appId, locationId);
        } catch (error) {
          cardErrors.textContent = error.message;
          return;
        }

        let card;
        try {
          card = await payments.card();
          await card.attach('#card-element');
        } catch (error) {
          cardErrors.textContent = error.message;
          return;
        }

        depositForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          cardErrors.textContent = '';

          if (!cart.length) {
            cardErrors.textContent = 'Add at least one treatment to your cart before checking out.';
            return;
          }

          const name = document.getElementById('guest-name').value;
          const email = document.getElementById('guest-email').value;
          const phone = document.getElementById('guest-phone').value;
          const appointmentDate = document.getElementById('appointment-date').value;
          const appointmentTime = document.getElementById('appointment-time').value;

          if (!appointmentDate || !appointmentTime) {
            cardErrors.textContent = 'Choose a date and time for your appointment.';
            return;
          }

          const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
          const depositAmount = depositPerItemCents * totalQuantity;

          try {
            const result = await card.tokenize();
            if (result.status !== 'OK') {
              throw new Error(result.errors?.[0]?.message || 'Card could not be tokenized.');
            }

            const response = await fetch('/process-payment', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                token: result.token,
                amount: depositAmount,
                name,
                email,
                phone,
                appointmentDate,
                appointmentTime,
                cart
              })
            });

            const data = await response.json();
            if (!response.ok) {
              throw new Error(data.error || 'Unable to finalize payment.');
            }

            cardErrors.textContent = 'Deposit received. Your calendar request and recap email are on the way.';
            depositForm.reset();
            cart.splice(0, cart.length);
            renderCart();
          } catch (error) {
            cardErrors.textContent = error.message;
          }
        });

        renderCart();
      };

      document.addEventListener('DOMContentLoaded', () => {
        initializeSquare();
      });
    </script>
  </body>
</html>
